### 前后端登录、登录设计

* ##### 前后端分离

* ##### 同源策略

* ##### 登录设计

* ##### 鉴权设计



> 前后端分离

在JSP的这些时代，个人觉得对于用户信息的一些展示和存取比较方便。但慢慢的项目越来越大，页面越来越多，后端与前端的分离变得越来越困难。且服务器资源是有限的，所以这是前后端集合一个特别不方便之处。

随着技术与业务场景的发展，前后端分离开始分明了起来，那么相较于以往的一个混合模式，前后端分离有一下优点：

* ##### 前后端分离明确，开发效率极大的提升

* ##### 更新迭代更为友好

* ##### 在基于MVC的模式下，程序分层明确，易于维护

但伴随着前后端的分离，以往一些请求在同样的状态，会出现跨域的问题。那么在事实上，跨域问题的出现实际就是同源策略的问题。

> 同源策略

##### 一个源的定义

如果两个页面的协议，端口（如果有指定）和域名都相同，则两个页面具有相同的**源**。

举个例子：

下表给出了相对http://a.xyz.com/dir/page.html同源检测的示例: 

| URL                                       | 结果 | 原因                     |
| ----------------------------------------- | ---- | ------------------------ |
| `http://a.xyz.com/dir2/other.html`        | 成功 |                          |
| `http://a.xyz.com/dir/inner/another.html` | 成功 |                          |
| `https://a.xyz.com/secure.html`           | 失败 | 不同协议 ( https和http ) |
| `http://a.xyz.com:81/dir/etc.html`        | 失败 | 不同端口 ( 81和80)       |
| `http://a.opq.com/dir/other.html`         | 失败 | 不同域名 ( xyz和opq)     |

##### 同源策略是什么

同源策略是浏览器的一个安全功能，不同源的客户端脚本在没有明确授权的情况下，不能读写对方资源。所以xyz.com下的js脚本采用ajax读取abc.com里面的文件数据是会被拒绝的。

同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。

那么对于这种同源的问题，目前有一下这几种方案解决

* ##### jsonp

* ##### cors

* ##### nginx

JSONP跨域

只支持GET请求，不支持POST等其它请求，也不支持复杂请求，只支持简单请求。

CORS跨域

支持所有的请求，包含GET、POST、OPTOIN、PUT、DELETE等。既支持复杂请求，也支持简单请求。

nginx这种方案是通过代理去解决了整个跨域的问题。

但对于目前来说，更多都是通过cors这种方案，开放端口的白名单进行一个跨域请求的解决方案。

[此处暂时有误，得继续搭建好代码与官网资料确认]

> 登录系统的设计

* 传统

  * ##### 用户名密码

  * ##### 手机验证码

* ##### 单点登录

  * #### SSO

    * ##### CAS

    * ##### Oauth2.0

    * ##### saml

在上述中，传统登录的方式还是保留并集成到了单点登录。单点登录在微服务的设计体系中，属于单独的服务验证，验证成功后通过颁发token令牌，并下发。使得用户能一次登录，便可使用多个系统。

> 鉴权设计

用户登录后，每次请求服务时客户端请求都要包含鉴权信息，服务端根据鉴权信息查询用户信息和其合法性。目前鉴权信息可以有如下方式：

### 1. 集中式 session 方式

在登录完成后，服务端将返回作为认证鉴权的随机不重复 token，客户端每次请求带上这个 token（一般放在请求的 header 里面）。服务端通过 token 查询到 token 对应的用户信息。

### 2. 令牌方式

登录完成后，服务端根据用户信息和其他安全因素加密生成一个安全令牌（也就是 JWTS，JSON Web Tokens），该令牌中包含了用户的身份信息，在认证鉴权时只需验证令牌的合法性即可，解密即可取到用户信息。

### 3. 比较

![img](https://pic3.zhimg.com/80/v2-210907438fa65f7b74800fd930691416_720w.jpg)

>  鉴权实现方案

### 1. 集中式 session 方式流程时序



![img](https://pic2.zhimg.com/80/v2-2ac9d7d7a4d31c0830ea491c1f499dc5_720w.jpg)



1. 客户端在未登录的状态下请求业务服务，在网关没有获取到认证信息时直接返回 401，告知客户端需要登录。
2. 客户端使用“手机号+密码”、“手机号+验证码”的方式请求登录服务。
3. 网关发现是登录服务后，请求登录认证服务。
4. 登录认证服务通过手机号码查询用户信息，同时生成 token。
5. 返回网关 token，网关将 token 返回给客户端。
6. 客户端带着 token 请求网关，网关将 token 传给鉴权服务，鉴权服务通过 token 查询用户信息并返回给网关，网关将用户信息转给业务服务，完成接下来的业务流程。

### 2. 令牌方式流程时序



![img](https://pic1.zhimg.com/80/v2-78983bcfbebcfb4b33dbea67b6575f88_720w.jpg)



1. 客户端在未登录的状态下请求业务服务，在网关没有获取到认证信息时直接返回 401，告知客户端需要登录。
2. 客户端使用“手机号+密码”、“手机号+验证码”的方式请求登录服务。
3. 网关发现是登录服务后，请求登录认证服务，同时生成 token（JWT信息），并将 token 返回给客户端。
4. 客户端带着 [token 请求网关](https://link.zhihu.com/?target=http%3A//mp.weixin.qq.com/s%3F__biz%3DMzU2MTI4MjI0MQ%3D%3D%26mid%3D2247485987%26idx%3D1%26sn%3Df0a1f851bec006e7aacbc0d5e183bac1%26chksm%3Dfc7a678dcb0dee9bb0619e363833f9e43f3c61ad57cf40a46cfb1d3ac840a90af51ea0a96ac0%26scene%3D21%23wechat_redirect)，网关根据 token（JWT信息）解密得到用户信息，并将用户信息转给业务服务，完成接下来的业务流程。

> 鉴权方案

### 1. 集中式Session鉴权技术方案

集中式Session鉴权验证用户身份有如下的实现方式：



![img](https://pic2.zhimg.com/80/v2-ad75c022f43350544e800191c6d483a5_720w.jpg)



### 2. 令牌方式鉴权技术方案

令牌方式鉴权的实现就简单的多， 网关直接解析 JWT 信息获取用户信息，然后带着用户信息去请求业务数据。